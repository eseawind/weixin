	if (Jxstar.systemVar.uploadType != '1') {		var y = Ext.isIE ? 1 : 0;		//在IE中要求直接点击file的按钮才能上传附件，否则会报错：form.submit();拒绝访问		config.toolext = function(node, tbar, extItems){			tbar.insert(1, {xtype:'form',baseCls:'x-plain',layout:'fit',				width:76,height:22,hideLabel:true,border:false,				items:[{					y:y,//不同浏览器的高度差一个像素					xtype:'fileuploadfield',					useType:'file',					name:'attach_path',					hidden:true,					buttonText:'添加附件',					listeners:{						afterrender: function(tf) {							//事后添加图标，原配置项不支持图标效果							tf.button.setIconClass('eb_create');						}					}				}]			});		};	}		//下载附件	var renderDown = function(val, metaData, record) {		var keyid = record.get('sys_attach__attach_id');				JxUtil.sysDownFile = function(kid) {			var params = 'funid=sys_attach&keyid='+ kid +'&pagetype=editgrid&eventcode=down';						if (Jxstar.systemVar.uploadType == '1') {				var url = Jxstar.systemVar.uploadUrl + '/fileAction.do?' + params + '&dataType=byte&nousercheck=1';				Ext.fly('frmhidden').dom.src = url;			} else {				Request.fileDown(params);			}		};				//onclick="JxUtil.sysDownFile(\''+ keyid +'\');"		var chgcolor = 'onmouseover="this.style.color=\'#FF4400\';" onmouseout="this.style.color=\'#0080FF\';"';		var html = '<a href="#" style=\'color:#0080FF;\' '+ chgcolor +'>&nbsp;'+ val +'&nbsp;</a>';		return html;	};	for (var i = 0; i < cols.length; i++) {		var f = cols[i].field;		if (f && f.name.indexOf('__attach_path') > 0) {			cols[i].col.renderer = renderDown;		}	}	config.eventcfg = {				delFile: function() {			var records = this.grid.getSelectionModel().getSelections();			if (!JxUtil.selected(records)) return;						var self = this;			var pkcol = self.define.pkcol;			var hdcall = function() {				//取选择记录的主键值				var keys = '';				for (var i = 0; i < records.length; i++) {					keys += '&keyid=' + records[i].get(pkcol);				}				//设置请求的参数				var params = 'funid=sys_attach'+ keys +'&pagetype=editgrid&eventcode=delete';				var endcall = function(data) {					//重新加载数据					self.grid.getStore().reload();				};				//发送请求				Request.postRequest(params, endcall);			};			//通过远程方法删除附件			var remoteCall = function() {				//取选择记录的主键值				var keys = '';				for (var i = 0; i < records.length; i++) {					keys += '&keyid=' + records[i].get(pkcol);				}				var url = Jxstar.systemVar.uploadUrl + '/fileAction.do?';				url += 'funid=sys_attach'+ keys +'&pagetype=editgrid&eventcode=delete&nousercheck=1';				Ext.fly('frmhidden').dom.src = url;				//延时执行回调函数，index.jsp中的frmhidden.load事件会提示执行完成！				JxUtil.delay(800, function(){					self.grid.getStore().reload();				});			};						//'确定删除选择的记录吗？'			Ext.Msg.confirm(jx.base.hint, jx.event.delyes, function(btn) {				if (btn == 'yes') {					if (Jxstar.systemVar.uploadType == '1') {						remoteCall();					} else {						hdcall();					}				}			});		}, 				downFile: function() {			var records = this.grid.getSelectionModel().getSelections();			if (!JxUtil.selectone(records)) return;						var keyid = records[0].get(this.define.pkcol);			var params = 'funid=sys_attach&keyid='+ keyid +'&pagetype=editgrid&eventcode=down';			//发送下载请求			if (Jxstar.systemVar.uploadType == '1') {				var url = Jxstar.systemVar.uploadUrl + '/fileAction.do?' + params + '&dataType=byte&nousercheck=1';				Ext.fly('frmhidden').dom.src = url;			} else {				Request.fileDown(params);			}		}	};		//业务记录复核后不能删除附件	config.initpage = function(gridNode){		var grid = gridNode.page;		//绑定点击事件，下载或者预览文件		grid.on('cellclick', JxAttach.showWinDoc);				//绑定上传附件方法		var onUpload = function(tbar) {			var tform = tbar.get(1);			var tfile = tform.get(0);						var dataId = grid.attachDataId || '';			var dataFunId = grid.attachFunId || '';			var dataField = '';						tfile.on('fileselected', function(tf, v){				if (v.length == 0) {					JxHint.alert('没有选择附件！');					return false;				}				var form = tf.ownerCt.getForm();								var params = 'funid=sys_attach&pagetype=editgrid&attach_name='+ encodeURIComponent(v);					params += '&attach_field=&dataid='+ dataId +'&datafunid='+ dataFunId +'&eventcode=create';								var hdCall = function() {					grid.getStore().reload();				};				//上传附件				Request.fileRequest(form, params, hdCall);			});		};			//查询关联附件		var queryRelat = function(tbar) {			//取来源功能ID与数据ID			var dataId = grid.attachDataId;			var dataFunId = grid.attachFunId;			if (!dataId || dataId.length == 0) return;			if (!dataFunId || dataFunId.length == 0) return;						var hdCall = function(data) {				if (Ext.isEmpty(data)) return;								var mitems = [];				for (var i = 0; i < data.length; i++) {					var data_id = data[i].data_id;					var attach_id = data[i].attach_id;					var attach_name = data[i].attach_name;					var content_type = data[i].content_type;										//构建附件菜单					var cfg = {						id:attach_id,						text:attach_name, 						handler:function(){							var params = 'funid=sys_attach&keyid='+ this.id +'&pagetype=editgrid&eventcode=down';							//发送下载请求							if (JxAttach.uploadType == '1') {								var url = JxAttach.uploadUrl + '/fileAction.do?' + params + '&dataType=byte&nousercheck=1';								Ext.fly('frmhidden').dom.src = url;							} else {								Request.fileDown(params);							}						}					};					//添加附件菜单					mitems[mitems.length] = cfg;				}								var len = data.length;				//先删除原来的按钮				var oldbtn = tbar.find('mycode', 'relat_menu')[0];				if (oldbtn) {tbar.remove(oldbtn, true);}				//再添加新的按钮				var menu = new Ext.menu.Menu({items: mitems});				tbar.add({					mycode: 'relat_menu',					text: '相关附件['+ len +']',					iconCls: 'eb_menu',					menu: menu				});				tbar.doLayout();			};						//从后台查询任务信息			var params = 'funid=sys_attach&pagetype=editgrid&eventcode=query_relat';				params += '&dataFunId='+ dataFunId +'&dataId='+ dataId;			Request.dataRequest(params, hdCall);		};				var hd = function(){			var deled = grid.attachDeled;			var tbar = grid.getTopToolbar();			if (Jxstar.systemVar.uploadType != '1') {				var btn = JxUtil.getButton(tbar, 'create');				if (btn) btn.hide();				onUpload(tbar);			}						if (!deled) {				var btn = JxUtil.getButton(tbar, 'delete');				if (btn) btn.disable();			}						//处理关联附件查询			var relat = Jxstar.systemVar.sys__attach__relat;			if (relat == '1' && gridNode.state == '0') {				tbar.add('-');				tbar.add({					mycode: 'relat_menu',					text: '相关附件[0]',					iconCls: 'eb_menu',					disabled: true				});				tbar.doLayout();								queryRelat(tbar);			}		};		var callhd = function() {			var tbar = grid.getTopToolbar();			var btn = JxUtil.getButton(tbar, 'delete');			if (tbar && btn) {				hd();			} else {				JxUtil.delay(1000, callhd);			}		};		JxUtil.delay(1000, callhd);	};